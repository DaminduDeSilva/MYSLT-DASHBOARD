name: CI/CD Pipeline

on:
  push:
    branches: [main]
  workflow_dispatch:  # Allows manual triggering

jobs:
  test-and-build:
    name: Test and Build
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'
          cache-dependency-path: |
            Server/package-lock.json
            client/package-lock.json

      - name: Install Backend Dependencies
        run: |
          echo "üì¶ Installing backend dependencies..."
          cd Server
          npm ci --silent
          echo "‚úÖ Backend: $(npm list --depth=0 | wc -l) packages installed"

      - name: Install Frontend Dependencies
        run: |
          echo "üì¶ Installing frontend dependencies..."
          cd client
          npm ci --silent
          echo "‚úÖ Frontend: $(npm list --depth=0 | wc -l) packages installed"

      - name: Build Frontend
        run: |
          echo "üèóÔ∏è Building frontend..."
          cd client
          npm run build
          
          echo "üîç Build output:"
          ls -la dist/
          du -sh dist/
          echo "‚úÖ Build successful!"

      - name: Upload Build Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: frontend-build
          path: client/dist/
          retention-days: 7

  deploy:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: test-and-build
    if: github.ref == 'refs/heads/main'  # Only deploy from main branch
    
    steps:
      - name: Download Build Artifacts
        uses: actions/download-artifact@v4
        with:
          name: frontend-build
          path: frontend-build

      - name: Verify Build Files
        run: |
          echo "üîç Verifying build artifacts..."
          [ -d frontend-build ] && echo "‚úÖ Build directory exists" || exit 1
          [ -f frontend-build/index.html ] && echo "‚úÖ index.html exists" || exit 1
          echo "‚úÖ All build files verified"

      - name: Deploy to Server
        uses: appleboy/ssh-action@v0.1.8
        with:
          host: '124.43.216.136'
          port: '9120'
          username: 'dpd'
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            # =============================================
            # üöÄ MySLT Dashboard Deployment
            # =============================================
            
            echo "========================================"
            echo "üöÄ Starting MySLT Dashboard Deployment"
            echo "========================================"
            echo "Branch: main"
            echo "Commit: ${{ github.sha }}"
            echo "Time: $(date)"
            echo "========================================"
            
            # 1. Navigate to project directory
            cd /var/www/MYSLT-DASHBOARD
            
            # 2. Backup current deployment
            echo "üì¶ Creating backup..."
            BACKUP_DIR="/home/dpd/deploy-backups/backup_$(date +%Y%m%d_%H%M%S)"
            mkdir -p $BACKUP_DIR
            if [ -d "client/dist" ]; then
              cp -r client/dist $BACKUP_DIR/
              echo "‚úÖ Frontend backed up to $BACKUP_DIR"
            fi
            
            # 3. Pull latest code
            echo "üì• Pulling latest code..."
            git fetch origin
            git reset --hard origin/main
            
            # 4. Install backend dependencies
            echo "üì¶ Installing backend dependencies..."
            cd Server
            npm install --production --silent
            
            # 5. Copy pre-built frontend from GitHub Actions
            echo "üì¶ Installing frontend build..."
            rm -rf ../client/dist
            mkdir -p ../client/dist
            cp -r /home/runner/work/MYSLT-DASHBOARD/MYSLT-DASHBOARD/frontend-build/* ../client/dist/
            
            # 6. Restart backend with PM2
            echo "üîÑ Restarting backend service..."
            pm2 restart myslt-backend || pm2 start src/server.js --name myslt-backend
            
            # 7. Reload Nginx
            echo "üîÑ Reloading Nginx..."
            sudo systemctl reload nginx
            
            # 8. Verify deployment
            echo "‚úÖ Verifying deployment..."
            sleep 3
            
            echo "üîç Service Status:"
            pm2 status myslt-backend | grep -A2 "myslt-backend"
            
            echo "üîç Checking Nginx..."
            sudo systemctl status nginx --no-pager | grep "Active:" | head -1
            
            echo "üîç Testing API..."
            if curl -f -s http://localhost:5001/api/health; then
              echo "‚úÖ API is responding"
            else
              echo "‚ö†Ô∏è API check failed (may need more time to start)"
            fi
            
            echo "========================================"
            echo "üéâ Production Deployment Complete!"
            echo "========================================"
            echo "‚úÖ Application deployed successfully"
            echo "üåê URL: https://dpdlab1.slt.lk:9122"
            echo "üìä API: https://dpdlab1.slt.lk:9122/api/health"
            echo "üíæ Backup: $BACKUP_DIR"
            echo "========================================"
            
            # 9. Clean old backups (keep last 5)
            echo "üßπ Cleaning old backups..."
            cd /home/dpd/deploy-backups
            ls -t | tail -n +6 | xargs rm -rf 2>/dev/null || true
            echo "‚úÖ Cleanup complete"

      - name: Post-Deployment Verification
        run: |
          echo "üîç Performing post-deployment checks..."
          sleep 10  # Wait for services to stabilize
          
          echo "Testing production endpoint..."
          if curl -f -s -k https://dpdlab1.slt.lk:9122/api/health; then
            echo "‚úÖ Production deployment verified!"
          else
            echo "‚ö†Ô∏è Production endpoint check failed (may need more time)"
          fi

  notify:
    name: Deployment Summary
    runs-on: ubuntu-latest
    needs: deploy
    if: always()
    
    steps:
      - name: Print Summary
        run: |
          echo "========================================"
          echo "üìä CI/CD Pipeline Summary"
          echo "========================================"
          echo "Repository: ${{ github.repository }}"
          echo "Branch: ${{ github.ref }}"
          echo "Commit: ${{ github.sha }}"
          echo "Author: ${{ github.actor }}"
          echo "Workflow: ${{ github.workflow }}"
          echo "Run ID: ${{ github.run_id }}"
          echo "Status: ${{ job.status }}"
          echo "Time: $(date -u)"
          echo "========================================"
          echo "üåê Production URL: https://dpdlab1.slt.lk:9122"
          echo "üìä API Health: https://dpdlab1.slt.lk:9122/api/health"
          echo "========================================"